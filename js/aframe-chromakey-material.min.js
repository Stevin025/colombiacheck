(() => {
  if ("undefined" == typeof AFRAME)
    throw new Error(
      "Component attempted to register before AFRAME was available."
    );
  AFRAME.registerShader("chromakey", {
    schema: {
      src: { type: "map" },
      color: {
        default: { x: 0.72, y: 0.72, z: 0.72 },
        type: "vec3",
        is: "uniform",
      },
      threshold: { default: 0.5, is: "uniform" },
      choker: { default: 0.1, is: "uniform" },
      transparent: { default: !0, is: "uniform" },
    },
    init: function (e) {
      var r = new THREE.VideoTexture(e.src);
      (r.minFilter = THREE.LinearFilter),
        (this.material = new THREE.ShaderMaterial({
          uniforms: {
            color: { type: "c", value: e.color },
            myTexture: { type: "t", value: r },
            threshold: { type: "f", value: e.threshold },
            choker: { type: "f", value: e.choker },
          },
          vertexShader: this.vertexShader,
          fragmentShader: this.fragmentShader,
        }));
    },
    update: function (e) {
      (this.material.uniforms.color.value = e.color),
        (this.material.uniforms.myTexture.value = new THREE.VideoTexture(e.src)),
        (this.material.uniforms.threshold.value = e.threshold),
        (this.material.uniforms.choker.value = e.choker),
        (this.material.transparent = e.transparent);
    },
    vertexShader: [
      "varying vec2 vUv;",
      "void main(void)",
      "{",
      "vUv = uv;",
      "vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",
      "gl_Position = projectionMatrix * mvPosition;",
      "}",
    ].join("\n"),
    fragmentShader: [
      "uniform sampler2D myTexture;",
      "uniform vec3 color;",
      "uniform float threshold;",
      "uniform float choker;",
      "varying vec2 vUv;",
      "void main(void)",
      "{",
      "vec3 tColor = texture2D( myTexture, vUv ).rgb;",
      "float alpha = smoothstep(threshold - choker, threshold, length(tColor - color));",
      "gl_FragColor = vec4(tColor, alpha);",
      "}",
    ].join("\n"),
  });
})();

